apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: demo
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: spire-demo
data:
  init.sql: |
    -- Create orders table
    CREATE TABLE IF NOT EXISTS orders (
      id SERIAL PRIMARY KEY,
      description VARCHAR(255) NOT NULL,
      status VARCHAR(50) NOT NULL DEFAULT 'pending',
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    -- Insert demo seed data (5 orders)
    INSERT INTO orders (description, status) VALUES
      ('Order for laptop and accessories', 'completed'),
      ('Bulk office supplies order', 'pending'),
      ('Emergency replacement keyboard', 'shipped'),
      ('Software license renewal', 'completed'),
      ('Conference room equipment', 'processing')
    ON CONFLICT DO NOTHING;

    -- Create index for common queries
    CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
    CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at DESC);

    -- Grant permissions (demo environment)
    GRANT ALL PRIVILEGES ON TABLE orders TO demouser;
    GRANT USAGE, SELECT ON SEQUENCE orders_id_seq TO demouser;
